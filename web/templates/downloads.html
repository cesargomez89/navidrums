{{define "content"}}
<h1>Downloads</h1>

<div class="downloads-toolbar">
    <div class="toolbar-row">
        <div class="toolbar-search-group">
            <input type="text" id="downloads-search" name="q" placeholder="Search by track, album, artist, genre..."
                onkeydown="if(event.key==='Enter') searchDownloads()">
            <button onclick="searchDownloads()" class="btn btn-outline btn-sm">Search</button>
        </div>
        <select id="downloads-filter" onchange="applyFilter()" class="form-select toolbar-filter">
            <option value="">All downloads</option>
            <option value="no_genre">No genre</option>
            {{range .Genres}}
            <option value="genre:{{.}}">{{.}}</option>
            {{end}}
        </select>
    </div>

    <div class="toolbar-row">
        <div class="toolbar-actions">
            <button id="btn-genre-selected" onclick="openGenreModal()" class="btn btn-outline btn-sm" disabled>
                Set Metadata (<span id="genre-count">0</span>)
            </button>
            <button id="btn-sync" onclick="bulkSync()" class="btn btn-outline btn-sm">
                Sync All
            </button>
            <button id="btn-delete-selected" onclick="bulkDelete()" class="btn btn-outline-danger btn-sm" disabled>
                Delete (<span id="selected-count">0</span>)
            </button>
        </div>
    </div>
</div>

<!-- Genre Modal -->
<div id="genre-modal-overlay" class="modal-overlay" style="display:none;" onclick="closeGenreModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <h2 style="margin: 0 0 16px;">Set Metadata</h2>
        <p style="font-size: 0.85rem; color: var(--text-dim); margin: 0 0 16px;">
            Updates metadata for all selected tracks in the database and re-tags the audio files.
            Empty fields will be ignored.
        </p>
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
            <input type="text" id="genre-input" placeholder="Genre (e.g. Electronic, Jazz, Rock...)"
                onkeydown="if(event.key==='Enter') applyMetadata()">
            <input type="number" id="year-input" placeholder="Year (e.g. 2024)" min="1900" max="2100"
                onkeydown="if(event.key==='Enter') applyMetadata()">
            <input type="text" id="mood-input" placeholder="Mood (e.g. Energetic, Chill, Melancholic...)"
                onkeydown="if(event.key==='Enter') applyMetadata()">
            <input type="text" id="style-input" placeholder="Style (e.g. Ambient, Techno, House...)"
                onkeydown="if(event.key==='Enter') applyMetadata()">
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeGenreModal()" class="btn btn-outline btn-sm">Cancel</button>
            <button onclick="applyMetadata()" class="btn btn-sm">Apply &amp; Sync to File</button>
        </div>
    </div>
</div>

<div id="downloads-list" hx-get="/htmx/downloads" hx-trigger="load">
    <div class="loading">Loading downloads...</div>
</div>

<script>
    // ─── helpers ───────────────────────────────────────────────────────
    function getSelectedIDs() {
        return Array.from(document.querySelectorAll('.download-cb:checked')).map(cb => cb.value);
    }

    function currentQ() {
        return document.getElementById('downloads-search').value;
    }

    function currentFilter() {
        return document.getElementById('downloads-filter').value;
    }

    function listParams() {
        var p = '';
        var q = currentQ();
        var f = currentFilter();
        if (q) p += 'q=' + encodeURIComponent(q);
        if (f) p += (p ? '&' : '') + 'filter=' + encodeURIComponent(f);
        return p ? '?' + p : '';
    }

    // ─── selection state ───────────────────────────────────────────────
    function onSelectionChange() {
        var ids = getSelectedIDs();
        var n = ids.length;
        document.getElementById('selected-count').textContent = n;
        document.getElementById('genre-count').textContent = n;

        var btnDel = document.getElementById('btn-delete-selected');
        var btnGenre = document.getElementById('btn-genre-selected');
        var btnSync = document.getElementById('btn-sync');

        if (btnDel) btnDel.disabled = (n === 0);
        if (btnGenre) btnGenre.disabled = (n === 0);
        if (btnSync) btnSync.textContent = n === 0 ? 'Sync All' : 'Sync (' + n + ')';

        var all = document.querySelectorAll('.download-cb');
        var selAll = document.getElementById('select-all-cb');
        if (selAll) {
            selAll.checked = all.length > 0 && n === all.length;
            selAll.indeterminate = n > 0 && n < all.length;
        }
    }

    function toggleSelectAll(master) {
        document.querySelectorAll('.download-cb').forEach(cb => { cb.checked = master.checked; });
        onSelectionChange();
    }

    // ─── search & filter ───────────────────────────────────────────────
    function searchDownloads() {
        // clear filter when doing a text search
        document.getElementById('downloads-filter').value = '';
        htmx.ajax('GET', '/htmx/downloads' + listParams(), {
            target: '#downloads-list', swap: 'innerHTML'
        });
    }

    function applyFilter() {
        // clear search when applying a filter
        document.getElementById('downloads-search').value = '';
        htmx.ajax('GET', '/htmx/downloads' + listParams(), {
            target: '#downloads-list', swap: 'innerHTML'
        });
    }

    // ─── single delete (from row button) ───────────────────────────────
    function deleteDownload(id) {
        if (!confirm('Are you sure you want to delete this download?')) return;
        htmx.ajax('DELETE', '/htmx/download/' + id + listParams(), {
            target: '#downloads-list', swap: 'innerHTML'
        });
    }

    // ─── bulk delete ───────────────────────────────────────────────────
    function bulkDelete() {
        var ids = getSelectedIDs();
        if (ids.length === 0) return;
        if (!confirm('Delete ' + ids.length + ' selected download(s)?')) return;
        _postForm('/htmx/downloads/bulk-delete' + listParams(), ids);
    }

    // ─── bulk sync ─────────────────────────────────────────────────────
    function bulkSync() {
        var ids = getSelectedIDs();
        if (ids.length === 0) { syncAll(); return; }
        if (!confirm('Sync MusicBrainz metadata for ' + ids.length + ' selected download(s)?')) return;
        _postForm('/htmx/downloads/bulk-sync' + listParams(), ids);
    }

    // ─── sync all ──────────────────────────────────────────────────────
    function syncAll() {
        if (!confirm('This will update metadata for all completed tracks using MusicBrainz (ISRC lookup).\n\n' +
            '- Only missing fields will be filled (existing data preserved)\n' +
            '- Audio files will be re-tagged with updated metadata\n' +
            '- Tracks without ISRC will be skipped\n' +
            '- MusicBrainz rate limits to ~1 request/second\n' +
            '- Operation cannot be undone\n\n' +
            'Continue?')) return;
        htmx.ajax('POST', '/htmx/downloads/sync', {
            target: '#downloads-list', swap: 'innerHTML'
        });
    }

    // ─── genre modal ───────────────────────────────────────────────────
    function openGenreModal() {
        document.getElementById('year-input').value = '';
        document.getElementById('genre-input').value = '';
        document.getElementById('mood-input').value = '';
        document.getElementById('style-input').value = '';
        document.getElementById('genre-modal-overlay').style.display = 'flex';
        setTimeout(() => document.getElementById('genre-input').focus(), 50);
    }

    function closeGenreModal(e) {
        if (!e || e.target === document.getElementById('genre-modal-overlay')) {
            document.getElementById('genre-modal-overlay').style.display = 'none';
        }
    }

    function applyMetadata() {
        var genre = document.getElementById('genre-input').value.trim();
        var year = document.getElementById('year-input').value.trim();
        var mood = document.getElementById('mood-input').value.trim();
        var style = document.getElementById('style-input').value.trim();

        if (!year && !genre && !mood && !style) {
            alert('Please enter at least one field.'); return;
        }
        var ids = getSelectedIDs();
        if (ids.length === 0) return;
        document.getElementById('genre-modal-overlay').style.display = 'none';
        var params = new URLSearchParams();
        ids.forEach(id => params.append('ids[]', id));
        if (year) params.set('year', year);
        if (genre) params.set('genre', genre);
        if (mood) params.set('mood', mood);
        if (style) params.set('style', style);
        fetch('/htmx/downloads/bulk-genre' + listParams(), { method: 'POST', body: params })
            .then(r => r.text())
            .then(html => {
                document.getElementById('downloads-list').innerHTML = html;
                htmx.process(document.getElementById('downloads-list'));
                onSelectionChange();
            });
    }

    // ─── helper: POST form with ids[] array ────────────────────────────
    function _postForm(url, ids) {
        var params = new URLSearchParams();
        ids.forEach(id => params.append('ids[]', id));
        fetch(url, { method: 'POST', body: params })
            .then(r => r.text())
            .then(html => {
                document.getElementById('downloads-list').innerHTML = html;
                htmx.process(document.getElementById('downloads-list'));
                onSelectionChange();
            });
    }

    // reset selection after any HTMX-driven swap on the list (single delete)
    document.body.addEventListener('htmx:afterSwap', function (e) {
        if (e.detail.target && e.detail.target.id === 'downloads-list') {
            onSelectionChange();
        }
    });
</script>
{{end}}
