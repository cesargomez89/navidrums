<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>navidrums Downloader</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.447.0/dist/umd/lucide.min.js"></script>
    <script src="/static/js/app.js"></script>
</head>

<body>
    <div class="container">
        <nav>
            <a href="/">Search</a>
            <a href="/queue">Queue</a>
            <a href="/history">History</a>
            <div class="provider-select-container">
                <span id="provider-name" onclick="openProviderModal()" style="cursor: pointer;">Loading...</span>
                <button class="btn-icon" onclick="openProviderModal()" title="Manage Providers">
                    <i data-lucide="settings"></i>
                </button>
            </div>
        </nav>
        <div id="content">
            {{block "content" .}}{{end}}
        </div>
    </div>

    <div id="provider-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Providers</h2>
                <button class="btn-close" onclick="closeProviderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Add Custom Provider</label>
                    <div class="input-row">
                        <input type="text" id="custom-provider-name" placeholder="Name">
                        <input type="text" id="custom-provider-url" placeholder="URL (e.g. https://api.example.com)">
                        <button class="btn-primary" onclick="addCustomProvider()">Add</button>
                    </div>
                </div>
                <div class="providers-list">
                    <h3>Available Providers</h3>
                    <div id="providers-list-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let providersData = null;

        function switchProvider(url) {
            if (!url) return;
            fetch('/htmx/provider/set?url=' + encodeURIComponent(url), {
                method: 'POST'
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    showNotification('Provider switched to: ' + getProviderName(url));
                    loadProviders();
                    loadProvidersModal();
                }
            });
        }

        function getProviderName(url) {
            if (!providersData) return url;
            if (url === providersData.default) return 'Default';
            for (let p of providersData.predefined) {
                if (p.url === url) return p.name;
            }
            for (let p of providersData.custom) {
                if (p.url === url) return p.name;
            }
            return url;
        }

        function loadProviders() {
            fetch('/htmx/providers', { cache: 'no-store' })
                .then(r => r.json())
                .then(data => {
                    providersData = data;
                    document.getElementById('provider-name').textContent = getProviderName(data.active);
                })
                .catch(err => {
                    console.error('Failed to load providers:', err);
                    if (providersData && providersData.default) {
                        document.getElementById('provider-name').textContent = 'Default';
                    } else {
                        document.getElementById('provider-name').textContent = 'Error';
                    }
                });
        }

        function openProviderModal() {
            document.getElementById('provider-modal').style.display = 'flex';
            loadProvidersModal();
        }

        function closeProviderModal() {
            document.getElementById('provider-modal').style.display = 'none';
        }

        function loadProvidersModal() {
            fetch('/htmx/providers', { cache: 'no-store' }).then(r => r.json()).then(data => {
                const container = document.getElementById('providers-list-container');
                container.innerHTML = '';
                
                let grouped = { 'Default (env)': [], 'Custom': [] };
                
                if (data.default) {
                    grouped['Default (env)'].push({ name: 'Default (from PROVIDER_URL)', url: data.default });
                }
                for (let p of data.custom || []) {
                    grouped['Custom'].push(p);
                }

                for (let category in grouped) {
                    if (grouped[category].length === 0) continue;
                    let groupDiv = document.createElement('div');
                    groupDiv.className = 'provider-group';
                    groupDiv.innerHTML = '<h4>' + category + '</h4>';
                    for (let p of grouped[category]) {
                        let item = document.createElement('div');
                        item.className = 'provider-item' + (p.url === data.active ? ' active' : '');
                        let buttons = '<button class="btn-sm" onclick="switchProvider(\'' + p.url + '\')">' + 
                            (p.url === data.active ? 'Active' : 'Select') + '</button>';
                        if (category === 'Custom') {
                            buttons += '<button class="btn-sm btn-danger" onclick="removeCustomProvider(\'' + p.url + '\')">Delete</button>';
                        }
                        item.innerHTML = '<span>' + p.name + '</span>' +
                            '<small>' + p.url + '</small>' +
                            buttons;
                        groupDiv.appendChild(item);
                    }
                    container.appendChild(groupDiv);
                }
            });
        }

        function addCustomProvider() {
            const name = document.getElementById('custom-provider-name').value;
            const url = document.getElementById('custom-provider-url').value;
            if (!name || !url) return;
            
            fetch('/htmx/provider/add?name=' + encodeURIComponent(name) + '&url=' + encodeURIComponent(url), {
                method: 'POST'
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    document.getElementById('custom-provider-name').value = '';
                    document.getElementById('custom-provider-url').value = '';
                    loadProvidersModal();
                    loadProviders();
                }
            });
        }

        function removeCustomProvider(url) {
            if (!confirm('Are you sure you want to remove this provider?')) return;
            
            fetch('/htmx/provider/remove?url=' + encodeURIComponent(url), {
                method: 'POST'
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    loadProvidersModal();
                    loadProviders();
                    showNotification('Provider removed');
                } else {
                    showNotification('Failed to remove provider');
                }
            });
        }

        function showNotification(msg) {
            const div = document.createElement('div');
            div.className = 'notification';
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadProviders();
            lucide.createIcons();
        });
    </script>
</body>

</html>