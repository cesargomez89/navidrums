{{define "content"}}
<h1>Settings</h1>

<div class="section">
    <h2>Current Provider</h2>
    <div id="current-provider">
        <span class="provider-badge">Loading...</span>
    </div>
</div>

<div class="section">
    <h2>Add Custom Provider</h2>
    <form class="provider-form" onsubmit="addProvider(event)">
        <input type="text" id="provider-name" placeholder="Name" required>
        <input type="url" id="provider-url" placeholder="URL (https://api.example.com)" required>
        <button type="submit" class="btn-lg btn-primary">+</button>
    </form>
</div>

<div class="section">
    <h2>Available Providers</h2>
    <div id="providers-list"></div>
</div>

<div class="section">
    <h2>Genre Mapping</h2>
    <p class="hint">Customize how MusicBrainz genres are normalized. Maps sub-genres to main genres.</p>
    <div id="genre-map-status"></div>
    <textarea id="genre-map-input" rows="12" style="width: 100%; font-family: monospace; font-size: 12px;" placeholder='{"death metal": "Metal", "indie pop": "Pop"}'></textarea>
    <div style="margin-top: 10px;">
        <button onclick="saveGenreMap()" class="btn btn-primary">Save</button>
        <button onclick="resetGenreMap()" class="btn btn-secondary">Reset to Default</button>
    </div>
</div>

<script>
function loadProviders() {
    fetch('/htmx/providers', { cache: 'no-store' })
        .then(r => r.json())
        .then(data => {
            document.querySelector('#current-provider .provider-badge').textContent = 
                data.active === data.default ? 'Default' : data.active;
            
            const container = document.getElementById('providers-list');
            container.innerHTML = '';
            
            let all = [];
            if (data.default) all.push({ name: 'Default (env)', url: data.default, isDefault: true });
            (data.custom || []).forEach(p => all.push(p));
            
            all.forEach(p => {
                const div = document.createElement('div');
                div.className = 'provider-card' + (p.url === data.active ? ' active' : '');
                div.innerHTML = `
                    <div class="provider-info">
                        <strong>${p.name}</strong>
                        <small>${p.url}</small>
                    </div>
                    <div class="provider-actions">
                        ${p.url === data.active 
                            ? '<button class="btn btn-success" disabled>Active</button>' 
                            : `<button onclick="setProvider('${p.url}')">Select</button>`}
                        ${p.isDefault ? '' : `<button class="btn btn-danger" onclick="removeProvider('${p.url}')">Delete</button>`}
                    </div>
                `;
                container.appendChild(div);
            });
        });
}

function setProvider(url) {
    fetch('/htmx/provider/set?url=' + encodeURIComponent(url), { method: 'POST' })
        .then(r => r.json())
        .then(() => loadProviders());
}

function addProvider(e) {
    e.preventDefault();
    const name = document.getElementById('provider-name').value;
    const url = document.getElementById('provider-url').value;
    fetch('/htmx/provider/add?name=' + encodeURIComponent(name) + '&url=' + encodeURIComponent(url), { method: 'POST' })
        .then(r => r.json())
        .then(() => {
            document.getElementById('provider-name').value = '';
            document.getElementById('provider-url').value = '';
            loadProviders();
        });
}

function removeProvider(url) {
    if (!confirm('Remove this provider?')) return;
    fetch('/htmx/provider/remove?url=' + encodeURIComponent(url), { method: 'POST' })
        .then(r => r.json())
        .then(() => loadProviders());
}

function loadGenreMap() {
    fetch('/htmx/genre-map', { cache: 'no-store' })
        .then(r => r.json())
        .then(data => {
            const textarea = document.getElementById('genre-map-input');
            const statusDiv = document.getElementById('genre-map-status');
            
            if (data.custom) {
                textarea.value = JSON.stringify(data.custom, null, 2);
                statusDiv.innerHTML = '<span class="badge badge-custom">Using custom mapping</span>';
            } else {
                textarea.value = JSON.stringify(data.default, null, 2);
                statusDiv.innerHTML = '<span class="badge badge-default">Using default mapping</span>';
            }
        });
}

function saveGenreMap() {
    const textarea = document.getElementById('genre-map-input');
    let genreMap;
    
    try {
        genreMap = JSON.parse(textarea.value);
    } catch (e) {
        alert('Invalid JSON: ' + e.message);
        return;
    }
    
    fetch('/htmx/genre-map', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ genreMap: genreMap })
    })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadGenreMap();
                alert('Genre map saved');
            }
        });
}

function resetGenreMap() {
    if (!confirm('Reset to default genre mapping?')) return;
    
    fetch('/htmx/genre-map/reset', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                loadGenreMap();
            }
        });
}

loadProviders();
loadGenreMap();
</script>
{{end}}
